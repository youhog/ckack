-- --- å®¿èˆæª¢æŸ¥ç³»çµ± - å…¨æ–°å»ºç«‹ SQL è…³æœ¬ (æ•´åˆ RBAC èˆ‡é è¨­è³‡æ–™ v1) ---
--
-- èªªæ˜ï¼šæ­¤è…³æœ¬ç”¨æ–¼å»ºç«‹æ‰€æœ‰å¿…è¦çš„è¡¨æ ¼ã€å‡½æ•¸ã€RLS ç­–ç•¥ï¼Œ
--       ä¸¦æ’å…¥åŸºç¤çš„è§’è‰²æ¬Šé™è¨­å®šå’Œä¸€äº›ç¯„ä¾‹è³‡æ–™ã€‚
--
-- ----------------------------------------------------------------

-- --- ç¬¬ 1 éƒ¨åˆ†ï¼šå»ºç«‹è³‡æ–™è¡¨ ---
--
-- ----------------------------------------------------------------

-- RBAC åŸºç¤çµæ§‹
CREATE TABLE public.roles (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, name text NOT NULL UNIQUE, description text NULL);
CREATE TABLE public.permissions (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, name text NOT NULL UNIQUE, description text NULL);
CREATE TABLE public.role_permissions (role_id uuid NOT NULL, permission_id uuid NOT NULL, PRIMARY KEY (role_id, permission_id));

-- æ‡‰ç”¨ç¨‹å¼è¡¨æ ¼
CREATE TABLE public.dorm_zones (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, name text NOT NULL UNIQUE, description text);
CREATE TABLE public.rooms (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, zone_id uuid NOT NULL, household text NULL, floor text NOT NULL, room_number text NOT NULL, capacity integer DEFAULT 4 NOT NULL, CONSTRAINT rooms_zone_floor_number_key UNIQUE (zone_id, floor, room_number), CONSTRAINT rooms_capacity_check CHECK ((capacity > 0)));
CREATE TABLE public.check_types (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, name text NOT NULL UNIQUE, description text);
CREATE TABLE public.checklist_categories (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, name text NOT NULL UNIQUE, icon text DEFAULT 'ğŸ“‹'::text, display_order integer DEFAULT 0);
CREATE TABLE public.checklist_items (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, category_id uuid NOT NULL, name text NOT NULL, display_order integer DEFAULT 0, CONSTRAINT checklist_items_category_id_name_key UNIQUE (category_id, name));
CREATE TABLE public.profiles (id uuid NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, email text UNIQUE);
CREATE TABLE public.user_roles (id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, user_id uuid NOT NULL UNIQUE, role text NOT NULL);
CREATE TABLE public.reports (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, user_id uuid, zone_id uuid, room_id uuid, check_type_id uuid, inspector_name text, additional_notes text, good_count integer DEFAULT 0, damaged_count integer DEFAULT 0, missing_count integer DEFAULT 0, check_data jsonb, notes_data jsonb, photo_data jsonb, report_content_html text);
CREATE TABLE public.key_returns (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, user_id uuid, zone_id uuid NOT NULL, room_id uuid NOT NULL, student_id text, bed_number text, return_notes text, is_returned boolean DEFAULT true NOT NULL);
CREATE TABLE public.student_allocations (id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, created_at timestamp with time zone DEFAULT now() NOT NULL, student_id text NOT NULL UNIQUE, zone_id uuid NOT NULL, room_id uuid NOT NULL, bed_number text NOT NULL, CONSTRAINT student_allocations_room_bed_key UNIQUE (room_id, bed_number));

-- --- ç¬¬ 2 éƒ¨åˆ†ï¼šå»ºç«‹å¤–éµé—œè¯ ---
--
-- ----------------------------------------------------------------
ALTER TABLE public.role_permissions ADD CONSTRAINT role_permissions_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles (id) ON DELETE CASCADE;
ALTER TABLE public.role_permissions ADD CONSTRAINT role_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.permissions (id) ON DELETE CASCADE;
ALTER TABLE public.user_roles ADD CONSTRAINT user_roles_role_fkey FOREIGN KEY (role) REFERENCES public.roles (name) ON DELETE RESTRICT; -- é™åˆ¶åˆªé™¤è§’è‰²ï¼Œè‹¥æœ‰ä½¿ç”¨è€…ä½¿ç”¨ä¸­
ALTER TABLE public.profiles ADD CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON DELETE CASCADE;
ALTER TABLE public.user_roles ADD CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id) ON DELETE CASCADE;
ALTER TABLE public.rooms ADD CONSTRAINT rooms_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.dorm_zones (id) ON DELETE CASCADE; -- åˆªé™¤å€åŸŸæ™‚ï¼Œç´šè¯åˆªé™¤å…¶ä¸‹æˆ¿é–“
ALTER TABLE public.checklist_items ADD CONSTRAINT checklist_items_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.checklist_categories (id) ON DELETE CASCADE; -- åˆªé™¤åˆ†é¡æ™‚ï¼Œç´šè¯åˆªé™¤å…¶ä¸‹é …ç›®
ALTER TABLE public.reports ADD CONSTRAINT reports_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id) ON DELETE SET NULL; -- åˆªé™¤ä½¿ç”¨è€…æ™‚ï¼Œå ±å‘Šä¿ç•™ä½† user_id è¨­ç‚º NULL
ALTER TABLE public.reports ADD CONSTRAINT reports_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.dorm_zones (id) ON DELETE SET NULL; -- åˆªé™¤å€åŸŸæ™‚ï¼Œå ±å‘Šä¿ç•™ä½† zone_id è¨­ç‚º NULL
ALTER TABLE public.reports ADD CONSTRAINT reports_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms (id) ON DELETE SET NULL; -- åˆªé™¤æˆ¿é–“æ™‚ï¼Œå ±å‘Šä¿ç•™ä½† room_id è¨­ç‚º NULL
ALTER TABLE public.reports ADD CONSTRAINT reports_check_type_id_fkey FOREIGN KEY (check_type_id) REFERENCES public.check_types (id) ON DELETE SET NULL; -- åˆªé™¤é¡å‹æ™‚ï¼Œå ±å‘Šä¿ç•™ä½† check_type_id è¨­ç‚º NULL
ALTER TABLE public.key_returns ADD CONSTRAINT key_returns_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id) ON DELETE SET NULL;
ALTER TABLE public.key_returns ADD CONSTRAINT key_returns_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.dorm_zones (id) ON DELETE CASCADE;
ALTER TABLE public.key_returns ADD CONSTRAINT key_returns_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms (id) ON DELETE CASCADE;
ALTER TABLE public.student_allocations ADD CONSTRAINT student_allocations_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.rooms (id) ON DELETE CASCADE;
ALTER TABLE public.student_allocations ADD CONSTRAINT student_allocations_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.dorm_zones (id) ON DELETE CASCADE;

-- --- ç¬¬ 3 éƒ¨åˆ†ï¼šè³‡æ–™åº«å‡½æ•¸èˆ‡è§¸ç™¼å™¨ ---
--
-- ----------------------------------------------------------------

-- ç²å–ç•¶å‰ä½¿ç”¨è€…çš„è§’è‰² (æ‡‰ç”¨ç¨‹å¼ç”¨)
CREATE OR REPLACE FUNCTION public.get_my_role()
 RETURNS text
 LANGUAGE sql
 SECURITY DEFINER
 STABLE SET search_path = public
AS $function$
  SELECT role FROM public.user_roles WHERE user_id = auth.uid();
$function$;

-- è™•ç†æ–°è¨»å†Šçš„ä½¿ç”¨è€… (è‡ªå‹•å»ºç«‹ profile å’Œé è¨­è§’è‰² 'inspector')
CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER SET search_path = public
AS $function$
BEGIN
  -- æ’å…¥ profile
  INSERT INTO public.profiles (id, email, created_at)
  VALUES (NEW.id, NEW.email, NEW.created_at)
  ON CONFLICT (id) DO NOTHING; -- å¦‚æœ profile å·²å­˜åœ¨å‰‡å¿½ç•¥

  -- æª¢æŸ¥ 'inspector' è§’è‰²æ˜¯å¦å­˜åœ¨
  IF EXISTS (SELECT 1 FROM public.roles WHERE name = 'inspector') THEN
    -- åˆ†é…é è¨­è§’è‰² 'inspector'
    INSERT INTO public.user_roles (user_id, role)
    VALUES (NEW.id, 'inspector')
    ON CONFLICT (user_id) DO NOTHING; -- å¦‚æœè§’è‰²å·²å­˜åœ¨å‰‡å¿½ç•¥
  ELSE
    -- å¦‚æœ 'inspector' è§’è‰²ä¸å­˜åœ¨ï¼Œç™¼å‡ºè­¦å‘Š
    RAISE WARNING 'Default role "inspector" not found. Cannot assign default role to new user %', NEW.id;
  END IF;

  RETURN NEW;
END;
$function$;

-- å»ºç«‹è§¸ç™¼å™¨ï¼Œåœ¨ auth.users è¡¨æ ¼æ’å…¥æ–°ä½¿ç”¨è€…å¾ŒåŸ·è¡Œ handle_new_user å‡½æ•¸
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- æ›´æ–°ä½¿ç”¨è€…è§’è‰² (ä¾› admin/superadmin ä½¿ç”¨)
CREATE OR REPLACE FUNCTION public.update_user_role(target_user_id uuid, new_role text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER SET search_path = public
AS $function$
DECLARE
  current_user_role text;
  target_user_current_role text;
BEGIN
  -- 1. æª¢æŸ¥åŸ·è¡Œè€…æ¬Šé™
  SELECT public.get_my_role() INTO current_user_role;
  IF current_user_role NOT IN ('admin', 'superadmin') THEN
    RAISE EXCEPTION 'æ¬Šé™ä¸è¶³ï¼šåªæœ‰ admin æˆ– superadmin å¯ä»¥æ›´æ”¹ä½¿ç”¨è€…è§’è‰²ã€‚';
  END IF;

  -- 2. æª¢æŸ¥ç›®æ¨™è§’è‰²æ˜¯å¦å­˜åœ¨
  IF NOT EXISTS (SELECT 1 FROM public.roles WHERE name = new_role) THEN
    RAISE EXCEPTION 'ç„¡æ•ˆçš„è§’è‰²: %', new_role;
  END IF;

  -- 3. ç¦æ­¢æ›´æ”¹è‡ªå·±çš„è§’è‰²
  IF target_user_id = auth.uid() THEN
    RAISE EXCEPTION 'ç„¡æ³•æ›´æ”¹è‡ªå·±çš„è§’è‰²ã€‚';
  END IF;

  -- 4. ç¦æ­¢æ›´æ”¹ superadmin çš„è§’è‰²
  SELECT role INTO target_user_current_role FROM public.user_roles WHERE user_id = target_user_id;
  IF target_user_current_role = 'superadmin' THEN
     RAISE EXCEPTION 'ç„¡æ³•æ›´æ”¹ superadmin çš„è§’è‰²ã€‚';
  END IF;

  -- 5. åŸ·è¡Œæ›´æ–°æˆ–æ’å…¥
  INSERT INTO public.user_roles (user_id, role)
  VALUES (target_user_id, new_role)
  ON CONFLICT (user_id) DO UPDATE SET role = new_role;
END;
$function$;

-- è¨­å®šåŸºç¤è§’è‰²èˆ‡æ¬Šé™ (æ ¸å¿ƒ RBAC è¨­å®š)
CREATE OR REPLACE FUNCTION public.setup_permissions()
 RETURNS text
 LANGUAGE plpgsql
AS $function$
DECLARE
  role_admin_id uuid;
  role_inspector_id uuid;
  role_superadmin_id uuid;
  role_sdc_id uuid;         -- å®¿å§”æœƒ
  role_sdsc_id uuid;        -- å®¿æœ
BEGIN
  -- 1. æ’å…¥åŸºç¤è§’è‰² (è‹¥ä¸å­˜åœ¨)
  INSERT INTO public.roles (name, description) VALUES
    ('admin', 'ç®¡ç†å“¡'),
    ('inspector', 'æª¢æŸ¥å“¡'),
    ('superadmin', 'è¶…ç´šç®¡ç†å“¡'),
    ('sdc', 'å®¿å§”æœƒ'),
    ('sdsc', 'å®¿æœ')
  ON CONFLICT (name) DO NOTHING;

  -- 2. ç²å–è§’è‰² ID
  SELECT id INTO role_admin_id FROM public.roles WHERE name = 'admin';
  SELECT id INTO role_inspector_id FROM public.roles WHERE name = 'inspector';
  SELECT id INTO role_superadmin_id FROM public.roles WHERE name = 'superadmin';
  SELECT id INTO role_sdc_id FROM public.roles WHERE name = 'sdc';
  SELECT id INTO role_sdsc_id FROM public.roles WHERE name = 'sdsc';

  -- æª¢æŸ¥æ˜¯å¦æ‰€æœ‰è§’è‰²éƒ½æˆåŠŸç²å– ID
  IF role_admin_id IS NULL OR role_inspector_id IS NULL OR role_superadmin_id IS NULL OR role_sdc_id IS NULL OR role_sdsc_id IS NULL THEN
    RAISE EXCEPTION 'åŸºç¤è§’è‰² ID æŸ¥è©¢å¤±æ•—ï¼Œç„¡æ³•è¨­å®šæ¬Šé™ã€‚è«‹æª¢æŸ¥ roles è¡¨æ ¼ã€‚';
  END IF;

  -- 3. æ’å…¥æ¬Šé™ (è‹¥ä¸å­˜åœ¨)
  INSERT INTO public.permissions (name, description) VALUES
    ('read_all_reports', 'è®€å–æ‰€æœ‰æª¢æŸ¥å ±å‘Š'),
    ('manage_zones', 'ç®¡ç†å®¿èˆå€åŸŸ'),
    ('manage_rooms', 'ç®¡ç†æˆ¿é–“'),
    ('manage_types', 'ç®¡ç†æª¢æŸ¥é¡å‹'),
    ('manage_checklist', 'ç®¡ç†æª¢æŸ¥é …ç›®'),
    ('manage_allocations', 'ç®¡ç†å­¸ç”ŸåºŠä½åˆ†é…'),
    ('manage_users', 'ç®¡ç†ä½¿ç”¨è€…å¸³è™Ÿèˆ‡è§’è‰²'),
    ('manage_permissions', 'ç®¡ç†è§’è‰²æ¬Šé™')
  ON CONFLICT (name) DO NOTHING;

  -- 4. æ¸…é™¤é€™äº›è§’è‰²çš„èˆŠæ¬Šé™é—œè¯ (ç¢ºä¿å†ªç­‰æ€§)
  DELETE FROM public.role_permissions
  WHERE role_id IN (role_admin_id, role_inspector_id, role_superadmin_id, role_sdc_id, role_sdsc_id);

  -- 5. åˆ†é…æ¬Šé™çµ¦è§’è‰²
  -- superadmin: æ“æœ‰æ‰€æœ‰æ¬Šé™
  INSERT INTO public.role_permissions (role_id, permission_id)
  SELECT role_superadmin_id, id FROM public.permissions
  ON CONFLICT DO NOTHING;

  -- admin: æ“æœ‰æ‰€æœ‰æ¬Šé™ (èˆ‡ superadmin ç›¸åŒï¼Œä»¥ä¾¿æ–¼ç®¡ç†)
  INSERT INTO public.role_permissions (role_id, permission_id)
  SELECT role_admin_id, id FROM public.permissions
  ON CONFLICT DO NOTHING;

  -- inspector: åªèƒ½è®€å–å ±å‘Š
  INSERT INTO public.role_permissions (role_id, permission_id)
  SELECT role_inspector_id, id FROM public.permissions WHERE name = 'read_all_reports'
  ON CONFLICT DO NOTHING;

  -- sdc (å®¿å§”æœƒ): è®€å–å ±å‘Šã€ç®¡ç†å€åŸŸã€æˆ¿é–“ã€æª¢æŸ¥é …ç›®ã€åºŠä½åˆ†é…
  INSERT INTO public.role_permissions (role_id, permission_id)
  SELECT role_sdc_id, id FROM public.permissions
  WHERE name IN ('read_all_reports', 'manage_zones', 'manage_rooms', 'manage_checklist', 'manage_allocations')
  ON CONFLICT DO NOTHING;

  -- sdsc (å®¿æœ): åªèƒ½è®€å–å ±å‘Š
  INSERT INTO public.role_permissions (role_id, permission_id)
  SELECT role_sdsc_id, id FROM public.permissions WHERE name = 'read_all_reports'
  ON CONFLICT DO NOTHING;

  RETURN 'åŸºç¤è§’è‰²å’Œæ¬Šé™è¨­ç½®å®Œæˆ';
END;
$function$;

-- å°‡ auth.users ä¸­å·²å­˜åœ¨çš„ä½¿ç”¨è€…åŒæ­¥åˆ° profiles å’Œ user_roles
CREATE OR REPLACE FUNCTION public.import_existing_users()
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER SET search_path = public
AS $function$
DECLARE
  user_record record;
  inserted_profiles integer := 0;
  inserted_roles integer := 0;
BEGIN
  -- å†æ¬¡ç¢ºèª 'inspector' è§’è‰²å­˜åœ¨
  IF NOT EXISTS (SELECT 1 FROM public.roles WHERE name = 'inspector') THEN
    RAISE WARNING 'é è¨­è§’è‰² "inspector" ä¸å­˜åœ¨ï¼Œç„¡æ³•è¨­å®šé è¨­è§’è‰²ã€‚';
    RETURN 'åŒ¯å…¥ä¸­æ­¢ï¼šé è¨­è§’è‰² "inspector" ä¸å­˜åœ¨ã€‚';
  END IF;

  -- éæ­· auth.users
  FOR user_record IN SELECT id, email, created_at FROM auth.users LOOP
    -- æ’å…¥ profile (è‹¥ä¸å­˜åœ¨)
    INSERT INTO public.profiles (id, email, created_at)
    VALUES (user_record.id, user_record.email, user_record.created_at)
    ON CONFLICT (id) DO NOTHING;
    -- è¨˜éŒ„æ˜¯å¦æ’å…¥äº†æ–°çš„ profile
    IF FOUND THEN
      inserted_profiles := inserted_profiles + 1;
    END IF;

    -- æ’å…¥é è¨­è§’è‰² 'inspector' (è‹¥ä¸å­˜åœ¨)
    INSERT INTO public.user_roles (user_id, role)
    VALUES (user_record.id, 'inspector')
    ON CONFLICT (user_id) DO NOTHING;
    -- è¨˜éŒ„æ˜¯å¦æ’å…¥äº†æ–°çš„è§’è‰²
    IF FOUND THEN
      inserted_roles := inserted_roles + 1;
    END IF;
  END LOOP;

  RETURN 'æ—¢æœ‰ä½¿ç”¨è€…åŒ¯å…¥å®Œæˆã€‚æ–°å¢ profiles: ' || inserted_profiles || ', æ–°å¢ user_roles: ' || inserted_roles;
END;
$function$;

-- --- ç¬¬ 4 éƒ¨åˆ†ï¼šå„²å­˜é«” (Storage) ---
-- ****** æ­¤éƒ¨åˆ†éœ€é€é Supabase UI æ‰‹å‹•è¨­å®š ******
-- 1. å‰å¾€ Storage -> Buckets -> Create bucket
-- 2. Bucket name: photos
-- 3. Public bucket: å‹¾é¸ (On)
-- 4. é»æ“Š "Create bucket"
-- 5. é»æ“Šå»ºç«‹å¥½çš„ 'photos' Bucket -> Policies
-- 6. é»æ“Š "New policy" -> "Create a policy from scratch"
-- 7. Policy name: Authenticated Upload
-- 8. Allowed operations: å‹¾é¸ INSERT
-- 9. Target roles: å‹¾é¸ authenticated
-- 10. USING expression / WITH CHECK expression (Policy definition):
--     (bucket_id = 'photos') AND (auth.uid() = (storage.foldername(name))[1]::uuid)
--     -- èªªæ˜ï¼šé€™å…è¨±å·²ç™»å…¥ä½¿ç”¨è€…åœ¨è‡ªå·± user_id çš„è³‡æ–™å¤¾ä¸‹ä¸Šå‚³æª”æ¡ˆ
-- 11. é»æ“Š "Review" -> "Save policy"
-- (é è¨­çš„ Public Read ç­–ç•¥é€šå¸¸å·²å­˜åœ¨ï¼Œå…è¨±æ‰€æœ‰äººè®€å–)
-- ----------------------------------------------------------------

-- --- ç¬¬ 5 éƒ¨åˆ†ï¼šè³‡æ–™åˆ—å±¤ç´šå®‰å…¨æ€§ (RLS) ç­–ç•¥ ---
--
-- ----------------------------------------------------------------
-- å•Ÿç”¨ RLS
-- --- ç¬¬ 5 éƒ¨åˆ†ï¼šè³‡æ–™åˆ—å±¤ç´šå®‰å…¨æ€§ (RLS) ç­–ç•¥ (ä¿®æ­£ç‰ˆ) ---
--
-- ----------------------------------------------------------------

-- å•Ÿç”¨ RLS (å¦‚æœå°šæœªå•Ÿç”¨)
ALTER TABLE public.dorm_zones ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.check_types ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.checklist_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.checklist_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.key_returns ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.student_allocations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;

-- å¼·åˆ¶å•Ÿç”¨ RLS
ALTER TABLE public.dorm_zones FORCE ROW LEVEL SECURITY;
ALTER TABLE public.rooms FORCE ROW LEVEL SECURITY;
ALTER TABLE public.check_types FORCE ROW LEVEL SECURITY;
ALTER TABLE public.checklist_categories FORCE ROW LEVEL SECURITY;
ALTER TABLE public.checklist_items FORCE ROW LEVEL SECURITY;
ALTER TABLE public.profiles FORCE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles FORCE ROW LEVEL SECURITY;
ALTER TABLE public.reports FORCE ROW LEVEL SECURITY;
ALTER TABLE public.key_returns FORCE ROW LEVEL SECURITY;
ALTER TABLE public.student_allocations FORCE ROW LEVEL SECURITY;
ALTER TABLE public.roles FORCE ROW LEVEL SECURITY;
ALTER TABLE public.permissions FORCE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions FORCE ROW LEVEL SECURITY;

-- --- æ¸…é™¤èˆŠç­–ç•¥ (ç¢ºä¿æ›¿æ›) ---
DROP POLICY IF EXISTS "Allow authenticated read" ON public.dorm_zones;
DROP POLICY IF EXISTS "Allow managers manage" ON public.dorm_zones;
DROP POLICY IF EXISTS "Allow admin manage" ON public.dorm_zones; -- æ¸…é™¤èˆŠå‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.rooms;
DROP POLICY IF EXISTS "Allow managers manage" ON public.rooms;
DROP POLICY IF EXISTS "Allow admin manage" ON public.rooms; -- æ¸…é™¤èˆŠå‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.check_types;
DROP POLICY IF EXISTS "Allow managers manage" ON public.check_types;
DROP POLICY IF EXISTS "Allow admin manage" ON public.check_types; -- æ¸…é™¤èˆŠå‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.checklist_categories;
DROP POLICY IF EXISTS "Allow managers manage" ON public.checklist_categories;
DROP POLICY IF EXISTS "Allow admin manage" ON public.checklist_categories; -- æ¸…é™¤èˆŠå‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.checklist_items;
DROP POLICY IF EXISTS "Allow managers manage" ON public.checklist_items;
DROP POLICY IF EXISTS "Allow admin manage" ON public.checklist_items; -- æ¸…é™¤èˆŠå‘½å
DROP POLICY IF EXISTS "Allow user read own" ON public.profiles;
DROP POLICY IF EXISTS "Allow managers read all" ON public.profiles;
DROP POLICY IF EXISTS "Allow admin read all" ON public.profiles; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow managers read all" ON public.user_roles;
DROP POLICY IF EXISTS "Allow admin read all" ON public.user_roles; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow user insert own" ON public.reports;
DROP POLICY IF EXISTS "Allow readers read" ON public.reports;
DROP POLICY IF EXISTS "Allow owner or admin read" ON public.reports; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow owner or manager delete" ON public.reports;
DROP POLICY IF EXISTS "Allow owner or admin delete" ON public.reports; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow user insert own" ON public.key_returns;
DROP POLICY IF EXISTS "Allow readers read" ON public.key_returns;
DROP POLICY IF EXISTS "Allow owner or admin read" ON public.key_returns; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow manager delete" ON public.key_returns;
DROP POLICY IF EXISTS "Allow admin delete" ON public.key_returns; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.student_allocations;
DROP POLICY IF EXISTS "Allow managers manage" ON public.student_allocations;
DROP POLICY IF EXISTS "Allow admin manage" ON public.student_allocations; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.roles;
DROP POLICY IF EXISTS "Allow managers manage" ON public.roles;
DROP POLICY IF EXISTS "Allow admin manage" ON public.roles; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.permissions;
DROP POLICY IF EXISTS "Allow managers manage" ON public.permissions;
DROP POLICY IF EXISTS "Allow admin manage" ON public.permissions; -- æ¸…é™¤æ—§å‘½å
DROP POLICY IF EXISTS "Allow authenticated read" ON public.role_permissions;
DROP POLICY IF EXISTS "Allow managers manage" ON public.role_permissions;
DROP POLICY IF EXISTS "Allow admin manage" ON public.role_permissions; -- æ¸…é™¤æ—§å‘½å

-- --- å‰µå»ºä¿®æ­£å¾Œçš„ç­–ç•¥ ---

-- roles: å…è¨±æ‰€æœ‰ç™»å…¥è€…è®€å–ï¼Œåªæœ‰ admin/superadmin å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.roles FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.roles FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'))
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin'));

-- permissions: å…è¨±æ‰€æœ‰ç™»å…¥è€…è®€å–ï¼Œåªæœ‰ admin/superadmin å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.permissions FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.permissions FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'))
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin'));

-- role_permissions: å…è¨±æ‰€æœ‰ç™»å…¥è€…è®€å–ï¼Œåªæœ‰ admin/superadmin å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.role_permissions FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.role_permissions FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'))
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin'));

-- user_roles: åªæœ‰ admin/superadmin å¯è®€å–æ‰€æœ‰ï¼Œ(æ›´æ–°ç”±å‡½æ•¸è™•ç†)
CREATE POLICY "Allow managers read all" ON public.user_roles FOR SELECT TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'));
-- (å¯é¸) å…è¨±ä½¿ç”¨è€…è®€å–è‡ªå·±çš„è§’è‰²
-- CREATE POLICY "Allow user read own role" ON public.user_roles FOR SELECT TO authenticated USING (user_id = auth.uid());

-- dorm_zones: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.dorm_zones FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.dorm_zones FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin', 'sdc')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin', 'sdc'));

-- rooms: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.rooms FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.rooms FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin', 'sdc')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin', 'sdc'));

-- check_types: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.check_types FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.check_types FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin'));

-- checklist_categories: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.checklist_categories FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.checklist_categories FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin', 'sdc')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin', 'sdc'));

-- checklist_items: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.checklist_items FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.checklist_items FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin', 'sdc')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin', 'sdc'));

-- profiles: ä½¿ç”¨è€…è®€è‡ªå·±ï¼Œadmin/superadmin è®€å…¨éƒ¨
CREATE POLICY "Allow user read own" ON public.profiles FOR SELECT TO authenticated USING (id = auth.uid());
CREATE POLICY "Allow managers read all" ON public.profiles FOR SELECT TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'));

-- reports: ä½¿ç”¨è€…å¯«è‡ªå·±ï¼›è‡ªå·±æˆ–æœ‰æ¬Šé™è€…è®€ï¼›è‡ªå·±æˆ– admin/superadmin åˆª
CREATE POLICY "Allow user insert own" ON public.reports FOR INSERT TO authenticated WITH CHECK (user_id = auth.uid());
CREATE POLICY "Allow readers read" ON public.reports FOR SELECT TO authenticated
  USING (user_id = auth.uid() OR public.get_my_role() IN ('admin', 'superadmin', 'sdc', 'sdsc'));
CREATE POLICY "Allow owner or manager delete" ON public.reports FOR DELETE TO authenticated
  USING (user_id = auth.uid() OR public.get_my_role() IN ('admin', 'superadmin'));

-- key_returns: ä½¿ç”¨è€…å¯«è‡ªå·±ï¼›è‡ªå·±æˆ–æœ‰æ¬Šé™è€…è®€ï¼›admin/superadmin åˆª
CREATE POLICY "Allow user insert own" ON public.key_returns FOR INSERT TO authenticated WITH CHECK (user_id = auth.uid());
CREATE POLICY "Allow readers read" ON public.key_returns FOR SELECT TO authenticated
  USING (user_id = auth.uid() OR public.get_my_role() IN ('admin', 'superadmin', 'sdc', 'sdsc'));
CREATE POLICY "Allow manager delete" ON public.key_returns FOR DELETE TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin'));

-- student_allocations: ç™»å…¥å¯è®€ï¼Œç‰¹å®šè§’è‰²å¯ç®¡ç†
CREATE POLICY "Allow authenticated read" ON public.student_allocations FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow managers manage" ON public.student_allocations FOR ALL TO authenticated
  USING (public.get_my_role() IN ('admin', 'superadmin', 'sdc')) -- æ ¹æ“š setup_permissions
  WITH CHECK (public.get_my_role() IN ('admin', 'superadmin', 'sdc'));

-- --- RLS ç­–ç•¥è¨­å®šå®Œæˆ ---
-- --- ç¬¬ 6 éƒ¨åˆ†ï¼šæ’å…¥é è¨­è³‡æ–™ ---
--
-- ----------------------------------------------------------------
-- æ’å…¥æª¢æŸ¥é¡å‹
INSERT INTO public.check_types (name, description) VALUES
  ('å­¸æœŸåˆæª¢æŸ¥', 'æª¢æŸ¥å­¸ç”Ÿå…¥ä½å‰çš„æˆ¿é–“ç‹€æ³'),
  ('æœŸä¸­å®‰å…¨æª¢æŸ¥', 'ä¾‹è¡Œæ€§çš„å®‰å…¨èˆ‡è¡›ç”ŸæŠ½æŸ¥'),
  ('å¯’å‡é›¢å®¿æª¢æŸ¥', 'ç¢ºèªå­¸ç”Ÿå¯’å‡é›¢å®¿æ™‚çš„æ¸…ç©ºç‹€æ³')
ON CONFLICT (name) DO NOTHING;

-- æ’å…¥å®¿èˆå€åŸŸ
INSERT INTO public.dorm_zones (name, description) VALUES
  ('A å€ (ç”·ç”Ÿå®¿èˆ)', 'A å€ä½æ–¼æ±å´ï¼Œé è¿‘ç±ƒçƒå ´'),
  ('B å€ (å¥³ç”Ÿå®¿èˆ)', 'B å€ä½æ–¼è¥¿å´ï¼Œé è¿‘é¤å»³')
ON CONFLICT (name) DO NOTHING;

-- æ’å…¥æˆ¿é–“ (ä½¿ç”¨ CTE ç²å– zone_id)
WITH zone_a AS (SELECT id FROM public.dorm_zones WHERE name = 'A å€ (ç”·ç”Ÿå®¿èˆ)'),
     zone_b AS (SELECT id FROM public.dorm_zones WHERE name = 'B å€ (å¥³ç”Ÿå®¿èˆ)')
INSERT INTO public.rooms (zone_id, floor, room_number, capacity, household) VALUES
  -- A å€
  ((SELECT id FROM zone_a), '1', '101', 4, NULL),
  ((SELECT id FROM zone_a), '1', '102', 4, NULL),
  ((SELECT id FROM zone_a), '2', '201', 4, NULL),
  ((SELECT id FROM zone_a), '2', '202', 4, NULL),
  -- B å€ (å‡è¨­æœ‰ household)
  ((SELECT id FROM zone_b), '1', '101', 4, 'H1'),
  ((SELECT id FROM zone_b), '1', '102', 2, 'H1'), -- å‡è¨­ 102 æ˜¯å…©äººæˆ¿
  ((SELECT id FROM zone_b), '2', '201', 4, 'H2'),
  ((SELECT id FROM zone_b), '2', '202', 4, 'H2')
ON CONFLICT (zone_id, floor, room_number) DO NOTHING;

-- æ’å…¥æª¢æŸ¥é …ç›®åˆ†é¡
INSERT INTO public.checklist_categories (name, icon, display_order) VALUES
  ('å¯¢å®¤å€åŸŸ', 'ğŸ›ï¸', 1),
  ('è¡›æµ´å€åŸŸ', 'ğŸ›', 2),
  ('å…¬å…±å€åŸŸ/é™½å°', 'ğŸª´', 3)
ON CONFLICT (name) DO NOTHING;

-- æ’å…¥æª¢æŸ¥é …ç›® (ä½¿ç”¨ CTE ç²å– category_id)
WITH cat_bedroom AS (SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'),
     cat_bathroom AS (SELECT id FROM public.checklist_categories WHERE name = 'è¡›æµ´å€åŸŸ'),
     cat_public AS (SELECT id FROM public.checklist_categories WHERE name = 'å…¬å…±å€åŸŸ/é™½å°')
INSERT INTO public.checklist_items (category_id, name, display_order) VALUES
  -- å¯¢å®¤å€åŸŸ
  ((SELECT id FROM cat_bedroom), 'åºŠæ¶ (å«åºŠæ¿)', 1),
  ((SELECT id FROM cat_bedroom), 'æ›¸æ¡Œ', 2),
  ((SELECT id FROM cat_bedroom), 'æ¤…å­', 3),
  ((SELECT id FROM cat_bedroom), 'è¡£æ«ƒ', 4),
  ((SELECT id FROM cat_bedroom), 'å†·æ°£ (å«é™æ§å™¨)', 5),
  -- è¡›æµ´å€åŸŸ
  ((SELECT id FROM cat_bathroom), 'é¦¬æ¡¶ (å«æ°´ç®±)', 1),
  ((SELECT id FROM cat_bathroom), 'æ´—æ‰‹å° (å«æ°´é¾é ­)', 2),
  ((SELECT id FROM cat_bathroom), 'æ·‹æµ´è¨­å‚™ (å«è“®è“¬é ­)', 3),
  ((SELECT id FROM cat_bathroom), 'ç½®ç‰©æ¶', 4),
  -- å…¬å…±å€åŸŸ/é™½å°
  ((SELECT id FROM cat_public), 'åœ°æ¿æ¸…æ½”', 1),
  ((SELECT id FROM cat_public), 'é™½å°çª—æˆ¶', 2)
ON CONFLICT (category_id, name) DO NOTHING;

-- (å¯é¸) æ’å…¥å­¸ç”ŸåºŠä½åˆ†é…ç¯„ä¾‹ (å¦‚æœéœ€è¦æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½ï¼Œå¯ä»¥çœç•¥é€™è£¡)
-- INSERT INTO public.student_allocations (student_id, zone_id, room_id, bed_number)
-- SELECT 'S12345678', dz.id, r.id, '1' FROM public.dorm_zones dz JOIN public.rooms r ON dz.id = r.zone_id WHERE dz.name = 'A å€ (ç”·ç”Ÿå®¿èˆ)' AND r.floor = '1' AND r.room_number = '101' ON CONFLICT (student_id) DO UPDATE SET zone_id=EXCLUDED.zone_id, room_id=EXCLUDED.room_id, bed_number=EXCLUDED.bed_number;
-- INSERT INTO public.student_allocations (student_id, zone_id, room_id, bed_number)
-- SELECT 'S87654321', dz.id, r.id, '2' FROM public.dorm_zones dz JOIN public.rooms r ON dz.id = r.zone_id WHERE dz.name = 'A å€ (ç”·ç”Ÿå®¿èˆ)' AND r.floor = '1' AND r.room_number = '101' ON CONFLICT (student_id) DO UPDATE SET zone_id=EXCLUDED.zone_id, room_id=EXCLUDED.room_id, bed_number=EXCLUDED.bed_number;


-- --- ç¬¬ 7 éƒ¨åˆ†ï¼šåŸ·è¡Œåˆå§‹åŒ–å‡½æ•¸ ---
--
-- ----------------------------------------------------------------
-- åŸ·è¡ŒåŸºç¤è§’è‰²èˆ‡æ¬Šé™è¨­å®š (ç¢ºä¿ roles, permissions, role_permissions è¡¨æ ¼æœ‰è³‡æ–™)
SELECT public.setup_permissions();

-- åŒæ­¥æ—¢æœ‰ä½¿ç”¨è€… (å°‡ auth.users ä¸­å·²å­˜åœ¨çš„ä½¿ç”¨è€…åŠ å…¥ profiles å’Œ user_roles)
SELECT public.import_existing_users();

-- ----------------------------------------------------------------
-- --- è…³æœ¬åŸ·è¡Œå®Œç•¢ ---
-- ----------------------------------------------------------------
-- æé†’ï¼šè«‹å‹™å¿…å·²é€é Supabase UI å»ºç«‹ photos Bucket åŠå…¶ç­–ç•¥ã€‚
-- ----------------------------------------------------------------