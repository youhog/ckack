-- --- å®¿èˆæª¢æŸ¥ç³»çµ± - å®Œæ•´ Supabase SQL è…³æœ¬ ---
--
-- æ­¤è…³æœ¬å°‡å»ºç«‹æ‰€æœ‰å¿…è¦çš„è³‡æ–™è¡¨ã€å‡½æ•¸ã€å„²å­˜é«”å’Œ RLS æ¬Šé™ç­–ç•¥ï¼Œ
-- ä»¥å®Œæ•´æ”¯æ´æ‚¨æä¾›çš„ Vue.js æ‡‰ç”¨ç¨‹å¼ã€‚
--
-- ----------------------------------------------------------------

-- --- ç¬¬ 1 éƒ¨åˆ†ï¼šå»ºç«‹è³‡æ–™è¡¨ ---
-- å»ºç«‹æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼éœ€è¦çš„è³‡æ–™è¡¨ã€‚
-- ----------------------------------------------------------------

-- 1. å®¿èˆå€åŸŸ (for ManageZones.vue)
CREATE TABLE public.dorm_zones (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    CONSTRAINT dorm_zones_pkey PRIMARY KEY (id),
    CONSTRAINT dorm_zones_name_key UNIQUE (name)
);
COMMENT ON TABLE public.dorm_zones IS 'å®¿èˆå€åŸŸ (ä¾‹å¦‚: F å€, A å€)';

-- 2. æˆ¿é–“ (for ManageRooms.vue)
CREATE TABLE public.rooms (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    zone_id uuid NOT NULL,
    room_number text NOT NULL,
    CONSTRAINT rooms_pkey PRIMARY KEY (id),
    CONSTRAINT rooms_zone_id_room_number_key UNIQUE (zone_id, room_number)
);
COMMENT ON TABLE public.rooms IS 'å®¿èˆæˆ¿é–“è™Ÿç¢¼ï¼Œéš¸å±¬æ–¼æŸå€‹å€åŸŸ';

-- 3. æª¢æŸ¥é¡å‹ (for ManageTypes.vue)
CREATE TABLE public.check_types (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    CONSTRAINT check_types_pkey PRIMARY KEY (id),
    CONSTRAINT check_types_name_key UNIQUE (name)
);
COMMENT ON TABLE public.check_types IS 'æª¢æŸ¥çš„é¡å‹ (ä¾‹å¦‚: å¯’å‡æª¢æŸ¥, å­¸æœŸåˆæª¢æŸ¥)';

-- 4. æª¢æŸ¥é …ç›®åˆ†é¡ (for ManageChecklist.vue)
CREATE TABLE public.checklist_categories (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    icon text DEFAULT 'ğŸ“‹'::text,
    display_order integer DEFAULT 0,
    CONSTRAINT checklist_categories_pkey PRIMARY KEY (id),
    CONSTRAINT checklist_categories_name_key UNIQUE (name)
);
COMMENT ON TABLE public.checklist_categories IS 'æª¢æŸ¥é …ç›®çš„åˆ†é¡ (ä¾‹å¦‚: å¯¢å…·å€åŸŸ, è¡›æµ´å€åŸŸ)';

-- 5. æª¢æŸ¥é …ç›® (for ManageChecklist.vue)
CREATE TABLE public.checklist_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    category_id uuid NOT NULL,
    name text NOT NULL,
    display_order integer DEFAULT 0,
    CONSTRAINT checklist_items_pkey PRIMARY KEY (id),
    CONSTRAINT checklist_items_category_id_name_key UNIQUE (category_id, name)
);
COMMENT ON TABLE public.checklist_items IS 'éš¸å±¬æ–¼æŸå€‹åˆ†é¡çš„å…·é«”æª¢æŸ¥é …ç›® (ä¾‹å¦‚: åºŠæ¶, è¡£æ«ƒ)';

-- 6. ä½¿ç”¨è€…å…¬é–‹è³‡æ–™ (for ManageUsers.vue & auth)
-- æ­¤è¡¨å°‡ç”± trigger è‡ªå‹•å¡«å……
CREATE TABLE public.profiles (
    id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    email text,
    CONSTRAINT profiles_pkey PRIMARY KEY (id),
    CONSTRAINT profiles_email_key UNIQUE (email)
);
COMMENT ON TABLE public.profiles IS 'å„²å­˜ä½¿ç”¨è€…çš„å…¬é–‹è³‡æ–™ï¼Œèˆ‡ auth.users é€£å‹•';

-- 7. ä½¿ç”¨è€…è§’è‰² (for ManageUsers.vue & auth)
-- æ­¤è¡¨å°‡ç”± trigger è‡ªå‹•å¡«å……
CREATE TABLE public.user_roles (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    CONSTRAINT user_roles_pkey PRIMARY KEY (id),
    CONSTRAINT user_roles_user_id_key UNIQUE (user_id)
);
COMMENT ON TABLE public.user_roles IS 'å„²å­˜ä½¿ç”¨è€…çš„è§’è‰² (admin æˆ– inspector)';

-- 8. æª¢æŸ¥å ±å‘Š (for Inspection.vue & AdminDashboard.vue)
CREATE TABLE public.reports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid,
    zone_id uuid,
    room_id uuid,
    check_type_id uuid,
    inspector_name text,
    additional_notes text,
    good_count integer DEFAULT 0,
    damaged_count integer DEFAULT 0,
    missing_count integer DEFAULT 0,
    check_data jsonb,
    notes_data jsonb,
    photo_data jsonb,
    report_content_html text,
    CONSTRAINT reports_pkey PRIMARY KEY (id)
);
COMMENT ON TABLE public.reports IS 'å„²å­˜æ‰€æœ‰æäº¤çš„æª¢æŸ¥å ±å‘Š';


-- --- ç¬¬ 2 éƒ¨åˆ†ï¼šå»ºç«‹å¤–éµ (Foreign Key) é—œè¯ ---
-- ç¢ºä¿è³‡æ–™çš„å®Œæ•´æ€§èˆ‡é—œè¯æ€§ã€‚
-- ----------------------------------------------------------------

-- 1. `profiles` é€£çµåˆ° `auth.users`
ALTER TABLE public.profiles
ADD CONSTRAINT profiles_id_fkey
FOREIGN KEY (id)
REFERENCES auth.users (id)
ON DELETE CASCADE;

-- 2. `user_roles` é€£çµåˆ° `auth.users`
ALTER TABLE public.user_roles
ADD CONSTRAINT user_roles_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES auth.users (id)
ON DELETE CASCADE;

-- 3. `rooms` é€£çµåˆ° `dorm_zones`
-- (åˆªé™¤å€åŸŸæ™‚ï¼Œåº•ä¸‹çš„æˆ¿é–“ä¹Ÿä¸€ä½µåˆªé™¤)
ALTER TABLE public.rooms
ADD CONSTRAINT rooms_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE CASCADE;

-- 4. `checklist_items` é€£çµåˆ° `checklist_categories`
-- (åˆªé™¤åˆ†é¡æ™‚ï¼Œåº•ä¸‹çš„é …ç›®ä¹Ÿä¸€ä½µåˆªé™¤)
ALTER TABLE public.checklist_items
ADD CONSTRAINT checklist_items_category_id_fkey
FOREIGN KEY (category_id)
REFERENCES public.checklist_categories (id)
ON DELETE CASCADE;

-- 5. `reports` é€£çµåˆ°å…¶ä»–è¡¨æ ¼
-- (å¦‚æœä¾†æºè¢«åˆªé™¤ï¼Œå ±å‘Šä¸­çš„é€£çµè¨­ç‚º NULLï¼Œä½†å ±å‘Šä¿ç•™)

-- é€£çµåˆ° `profiles` (ä¿®å¾© 400 éŒ¯èª¤çš„é—œéµ)
ALTER TABLE public.reports
ADD CONSTRAINT reports_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES public.profiles (id)
ON DELETE SET NULL;

-- é€£çµåˆ° `dorm_zones`
ALTER TABLE public.reports
ADD CONSTRAINT reports_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE SET NULL;

-- é€£çµåˆ° `rooms`
ALTER TABLE public.reports
ADD CONSTRAINT reports_room_id_fkey
FOREIGN KEY (room_id)
REFERENCES public.rooms (id)
ON DELETE SET NULL;

-- é€£çµåˆ° `check_types`
ALTER TABLE public.reports
ADD CONSTRAINT reports_check_type_id_fkey
FOREIGN KEY (check_type_id)
REFERENCES public.check_types (id)
ON DELETE SET NULL;


-- --- ç¬¬ 3 éƒ¨åˆ†ï¼šè³‡æ–™åº«å‡½æ•¸ (RPC) èˆ‡è§¸ç™¼å™¨ (Triggers) ---
-- è‡ªå‹•åŒ–è™•ç†ä½¿ç”¨è€…è§’è‰²å’Œè³‡æ–™ã€‚
-- ----------------------------------------------------------------

-- 1. å‡½æ•¸ï¼šç²å–ç›®å‰ä½¿ç”¨è€…çš„è§’è‰²
-- (è¢« RLS ç­–ç•¥å’Œ main.js å»£æ³›ä½¿ç”¨)
CREATE OR REPLACE FUNCTION public.get_my_role()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
AS $$
    SELECT role
    FROM public.user_roles
    WHERE user_id = auth.uid();
$$;

-- 2. å‡½æ•¸ï¼šè™•ç†æ–°ä½¿ç”¨è€…è¨»å†Š (for Login.vue)
-- (è‡ªå‹•åœ¨ profiles å’Œ user_roles ä¸­å»ºç«‹ç´€éŒ„)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- 1. åœ¨ profiles å»ºç«‹ç´€éŒ„
    INSERT INTO public.profiles (id, email)
    VALUES (NEW.id, NEW.email);
    
    -- 2. åœ¨ user_roles å»ºç«‹ç´€éŒ„ï¼Œé è¨­ç‚º 'inspector'
    INSERT INTO public.user_roles (user_id, role)
    VALUES (NEW.id, 'inspector');
    
    RETURN NEW;
END;
$$;

-- 3. è§¸ç™¼å™¨ï¼šç•¶ auth.users æœ‰æ–°ä½¿ç”¨è€…æ™‚ï¼ŒåŸ·è¡Œ handle_new_user
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_user();


-- 4. å‡½æ•¸ï¼šæ›´æ–°ä½¿ç”¨è€…è§’è‰² (for ManageUsers.vue)
-- (å…è¨± admin æ›´æ”¹å…¶ä»–äººçš„è§’è‰²)
CREATE OR REPLACE FUNCTION public.update_user_role(target_user_id uuid, new_role text)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- æª¢æŸ¥åŸ·è¡Œè€…æ˜¯å¦ç‚º 'admin'
    IF public.get_my_role() != 'admin' THEN
        RAISE EXCEPTION 'æ¬Šé™ä¸è¶³ï¼šåªæœ‰ admin å¯ä»¥æ›´æ”¹ä½¿ç”¨è€…è§’è‰²';
    END IF;
    
    -- æª¢æŸ¥æ˜¯å¦è©¦åœ–æ›´æ”¹è‡ªå·±çš„è§’è‰² (Vue ä¸­å·²æœ‰é˜²è­·ï¼Œä½†å¾Œç«¯å†åŠ ä¸€å±¤)
    IF target_user_id = auth.uid() THEN
        RAISE EXCEPTION 'ç„¡æ³•æ›´æ”¹è‡ªå·±çš„è§’è‰²';
    END IF;

    -- æ›´æ–°æˆ–æ’å…¥è§’è‰²
    INSERT INTO public.user_roles (user_id, role)
    VALUES (target_user_id, new_role)
    ON CONFLICT (user_id)
    DO UPDATE SET role = new_role;
END;
$$;


-- --- ç¬¬ 4 éƒ¨åˆ†ï¼šå„²å­˜é«” (Storage) ---
-- å»ºç«‹ 'photos' å„²å­˜æ¡¶ (for PhotoUploader.vue)
-- ----------------------------------------------------------------

-- å»ºç«‹ä¸€å€‹åç‚º 'photos' çš„å…¬é–‹å„²å­˜æ¡¶
INSERT INTO storage.buckets (id, name, public)
VALUES ('photos', 'photos', true)
ON CONFLICT (id) DO NOTHING;

-- RLSï¼šå…è¨±å·²ç™»å…¥ä½¿ç”¨è€…ä¸Šå‚³ç…§ç‰‡
CREATE POLICY "Allow authenticated users to upload photos"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK ( bucket_id = 'photos' );

-- RLSï¼šå…è¨±æ‰€æœ‰äººè®€å–ç…§ç‰‡ (å› ç‚ºæ˜¯ public bucket)
-- (Supabase é€šå¸¸æœƒè‡ªå‹•å»ºç«‹ï¼Œä½†ç‚ºä¿éšªèµ·è¦‹)
CREATE POLICY "Allow public read access to photos"
ON storage.objects FOR SELECT
USING ( bucket_id = 'photos' );


-- --- ç¬¬ 5 éƒ¨åˆ†ï¼šè³‡æ–™åˆ—å±¤ç´šå®‰å…¨æ€§ (RLS) ç­–ç•¥ ---
-- 
-- é€™æ˜¯ä¿®å¾©ã€Œè³‡æ–™ç‚ºç©ºã€å•é¡Œçš„é—œéµã€‚
-- 
-- ----------------------------------------------------------------

-- --- 5a. è¨­å®šæª”è¡¨æ ¼ (æ‰€æœ‰äººå¯è®€ï¼Œåƒ… Admin å¯å¯«) ---

-- dorm_zones
ALTER TABLE public.dorm_zones ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read zones" ON public.dorm_zones;
DROP POLICY IF EXISTS "Allow admin to manage zones" ON public.dorm_zones;
CREATE POLICY "Allow authenticated users to read zones" ON public.dorm_zones FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage zones" ON public.dorm_zones FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- rooms
ALTER TABLE public.rooms ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read rooms" ON public.rooms;
DROP POLICY IF EXISTS "Allow admin to manage rooms" ON public.rooms;
CREATE POLICY "Allow authenticated users to read rooms" ON public.rooms FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage rooms" ON public.rooms FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- check_types
ALTER TABLE public.check_types ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read check_types" ON public.check_types;
DROP POLICY IF EXISTS "Allow admin to manage check_types" ON public.check_types;
CREATE POLICY "Allow authenticated users to read check_types" ON public.check_types FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage check_types" ON public.check_types FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- checklist_categories
ALTER TABLE public.checklist_categories ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read categories" ON public.checklist_categories;
DROP POLICY IF EXISTS "Allow admin to manage categories" ON public.checklist_categories;
CREATE POLICY "Allow authenticated users to read categories" ON public.checklist_categories FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage categories" ON public.checklist_categories FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- checklist_items
ALTER TABLE public.checklist_items ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read items" ON public.checklist_items;
DROP POLICY IF EXISTS "Allow admin to manage items" ON public.checklist_items;
CREATE POLICY "Allow authenticated users to read items" ON public.checklist_items FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage items" ON public.checklist_items FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- --- 5b. ä½¿ç”¨è€…è³‡æ–™ (åƒ… Admin å¯è®€/å¯«ï¼Œä½¿ç”¨è€…å¯è®€è‡ªå·±) ---

-- profiles
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow admins to read all profiles" ON public.profiles;
DROP POLICY IF EXISTS "Allow users to read their own profile" ON public.profiles;
CREATE POLICY "Allow admins to read all profiles" ON public.profiles FOR SELECT TO authenticated USING (public.get_my_role() = 'admin');
CREATE POLICY "Allow users to read their own profile" ON public.profiles FOR SELECT TO authenticated USING (id = auth.uid());

-- user_roles
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow admins to read all user_roles" ON public.user_roles;
CREATE POLICY "Allow admins to read all user_roles" ON public.user_roles FOR SELECT TO authenticated USING (public.get_my_role() = 'admin');
-- (æ³¨æ„: å¯«å…¥æ¬Šé™æ˜¯é€é `update_user_role` å‡½æ•¸ç¹éçš„)

-- --- 5c. å ±å‘Šè³‡æ–™ (æ‰€æœ‰äººå¯æ–°å¢ï¼ŒAdmin å¯è®€/åˆªå…¨éƒ¨ï¼ŒInspector å¯è®€/åˆªè‡ªå·±) ---

-- reports
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to insert reports" ON public.reports;
DROP POLICY IF EXISTS "Allow admins to read/delete all reports" ON public.reports;
DROP POLICY IF EXISTS "Allow inspectors to read/delete their own reports" ON public.reports;

-- 1. å…è¨±æ‰€æœ‰ç™»å…¥è€…æ–°å¢å ±å‘Š
CREATE POLICY "Allow authenticated users to insert reports"
ON public.reports FOR INSERT TO authenticated
WITH CHECK ( user_id = auth.uid() );

-- 2. å…è¨± Admin è®€å–å’Œåˆªé™¤æ‰€æœ‰å ±å‘Š
CREATE POLICY "Allow admins to read/delete all reports"
ON public.reports FOR SELECT USING ( public.get_my_role() = 'admin' );
CREATE POLICY "Allow admins to delete all reports"
ON public.reports FOR DELETE USING ( public.get_my_role() = 'admin' );

-- 3. å…è¨± Inspector è®€å–å’Œåˆªé™¤è‡ªå·±çš„å ±å‘Š
CREATE POLICY "Allow inspectors to read/delete their own reports"
ON public.reports FOR SELECT USING ( user_id = auth.uid() );
CREATE POLICY "Allow inspectors to delete their own reports"
ON public.reports FOR DELETE USING ( user_id = auth.uid() );

-- ----------------------------------------------------------------
-- --- è…³æœ¬åŸ·è¡Œå®Œç•¢ ---
-- ----------------------------------------------------------------