-- --- å®¿èˆæª¢æŸ¥ç³»çµ± - çµ‚æ¥µå®Œæ•´ SQL è…³æœ¬ (v7 - æ–°å¢åºŠä½åˆ†é…è¡¨) ---
--
-- æ­¤è…³æœ¬åŒ…å«ï¼š
-- 1. å®Œæ•´è³‡æ–™è¡¨çµæ§‹ (åŒ…å« profiles, user_roles, student_allocations)
-- 2. å®Œæ•´å¤–éµ (Foreign Key) é—œè¯
-- 3. è‡ªå‹•åŒ–å‡½æ•¸ (Functions) èˆ‡è§¸ç™¼å™¨ (Triggers)
-- 4. å„²å­˜é«” (Storage) è¨­å®š
-- 5. å®Œæ•´ RLS (è³‡æ–™åˆ—å±¤ç´šå®‰å…¨æ€§) ç­–ç•¥
-- 6. ç¯„ä¾‹è³‡æ–™ (ç”¨æ–¼æ¸¬è©¦)
--
-- ----------------------------------------------------------------

-- --- ç¬¬ 0 éƒ¨åˆ†ï¼šé å…ˆåˆªé™¤å¯èƒ½è¡çªçš„å‡½æ•¸ (ä½¿ç”¨ CASCADE) ---
DROP FUNCTION IF EXISTS public.get_my_role() CASCADE;
-- (å…¶ä»–å¯èƒ½éœ€è¦é å…ˆåˆªé™¤çš„å‡½æ•¸å¯ä»¥åœ¨æ­¤è™•åŠ å…¥)

-- --- ç¬¬ 1 éƒ¨åˆ†ï¼šå»ºç«‹è³‡æ–™è¡¨ (å®‰å…¨æ¨¡å¼) ---
--
-- ----------------------------------------------------------------

-- 1. å®¿èˆå€åŸŸ
CREATE TABLE IF NOT EXISTS public.dorm_zones (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    CONSTRAINT dorm_zones_pkey PRIMARY KEY (id),
    CONSTRAINT dorm_zones_name_key UNIQUE (name)
);
COMMENT ON TABLE public.dorm_zones IS 'å®¿èˆå€åŸŸ (ä¾‹å¦‚: F å€, A å€)';

-- 2. æˆ¿é–“
CREATE TABLE IF NOT EXISTS public.rooms (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    zone_id uuid NOT NULL,
    room_number text NOT NULL,
    CONSTRAINT rooms_pkey PRIMARY KEY (id),
    CONSTRAINT rooms_zone_id_room_number_key UNIQUE (zone_id, room_number)
);
COMMENT ON TABLE public.rooms IS 'å®¿èˆæˆ¿é–“è™Ÿç¢¼ï¼Œéš¸å±¬æ–¼æŸå€‹å€åŸŸ';

-- 3. æª¢æŸ¥é¡å‹
CREATE TABLE IF NOT EXISTS public.check_types (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    CONSTRAINT check_types_pkey PRIMARY KEY (id),
    CONSTRAINT check_types_name_key UNIQUE (name)
);
COMMENT ON TABLE public.check_types IS 'æª¢æŸ¥çš„é¡å‹ (ä¾‹å¦‚: å¯’å‡æª¢æŸ¥, å­¸æœŸåˆæª¢æŸ¥)';

-- 4. æª¢æŸ¥é …ç›®åˆ†é¡
CREATE TABLE IF NOT EXISTS public.checklist_categories (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    icon text DEFAULT 'ğŸ“‹'::text,
    display_order integer DEFAULT 0,
    CONSTRAINT checklist_categories_pkey PRIMARY KEY (id),
    CONSTRAINT checklist_categories_name_key UNIQUE (name)
);
COMMENT ON TABLE public.checklist_categories IS 'æª¢æŸ¥é …ç›®çš„åˆ†é¡ (ä¾‹å¦‚: å¯¢å…·å€åŸŸ, è¡›æµ´å€åŸŸ)';

-- 5. æª¢æŸ¥é …ç›®
CREATE TABLE IF NOT EXISTS public.checklist_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    category_id uuid NOT NULL,
    name text NOT NULL,
    display_order integer DEFAULT 0,
    CONSTRAINT checklist_items_pkey PRIMARY KEY (id),
    CONSTRAINT checklist_items_category_id_name_key UNIQUE (category_id, name)
);
COMMENT ON TABLE public.checklist_items IS 'éš¸å±¬æ–¼æŸå€‹åˆ†é¡çš„å…·é«”æª¢æŸ¥é …ç›® (ä¾‹å¦‚: åºŠæ¶, è¡£æ«ƒ)';

-- 6. ä½¿ç”¨è€…å…¬é–‹è³‡æ–™ (profiles)
CREATE TABLE IF NOT EXISTS public.profiles (
    id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    email text,
    CONSTRAINT profiles_pkey PRIMARY KEY (id),
    CONSTRAINT profiles_email_key UNIQUE (email)
);
COMMENT ON TABLE public.profiles IS 'å„²å­˜ä½¿ç”¨è€…çš„å…¬é–‹è³‡æ–™ï¼Œèˆ‡ auth.users é€£å‹•';

-- 7. ä½¿ç”¨è€…è§’è‰² (user_roles)
CREATE TABLE IF NOT EXISTS public.user_roles (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    CONSTRAINT user_roles_pkey PRIMARY KEY (id),
    CONSTRAINT user_roles_user_id_key UNIQUE (user_id)
);
COMMENT ON TABLE public.user_roles IS 'å„²å­˜ä½¿ç”¨è€…çš„è§’è‰² (admin æˆ– inspector)';

-- 8. æª¢æŸ¥å ±å‘Š
CREATE TABLE IF NOT EXISTS public.reports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid,
    zone_id uuid,
    room_id uuid,
    check_type_id uuid,
    inspector_name text,
    additional_notes text,
    good_count integer DEFAULT 0,
    damaged_count integer DEFAULT 0,
    missing_count integer DEFAULT 0,
    check_data jsonb,
    notes_data jsonb,
    photo_data jsonb,
    report_content_html text,
    CONSTRAINT reports_pkey PRIMARY KEY (id)
);
COMMENT ON TABLE public.reports IS 'å„²å­˜æ‰€æœ‰æäº¤çš„æª¢æŸ¥å ±å‘Š';

-- 9. é‘°åŒ™æ­¸é‚„è¨˜éŒ„
CREATE TABLE IF NOT EXISTS public.key_returns (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid, -- ç´€éŒ„è™•ç†æ­¸é‚„çš„äºº
    zone_id uuid NOT NULL,
    room_id uuid NOT NULL,
    student_id text, -- å­¸ç”Ÿå­¸è™Ÿ/ID
    bed_number text, -- åºŠä½è™Ÿç¢¼ (ä¾‹å¦‚: '1', 'A')
    return_notes text,
    is_returned boolean DEFAULT true NOT NULL,
    CONSTRAINT key_returns_pkey PRIMARY KEY (id)
);
COMMENT ON TABLE public.key_returns IS 'å„²å­˜æˆ¿é–“é‘°åŒ™æ­¸é‚„ç´€éŒ„ï¼Œä¸¦èˆ‡ç‰¹å®šåºŠä½/å­¸ç”Ÿé€£çµã€‚';

-- 10. å­¸ç”ŸåºŠä½åˆ†é… (NEW TABLE)
CREATE TABLE IF NOT EXISTS public.student_allocations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    student_id text NOT NULL, -- å­¸è™Ÿ (å”¯ä¸€è­˜åˆ¥ç¢¼)
    zone_id uuid NOT NULL,
    room_id uuid NOT NULL,
    bed_number text NOT NULL, -- å¯¦éš›åºŠä½è™Ÿ (1, 2, 3, 4)
    CONSTRAINT student_allocations_pkey PRIMARY KEY (id),
    CONSTRAINT student_allocations_student_id_key UNIQUE (student_id),
    CONSTRAINT student_allocations_room_bed_key UNIQUE (room_id, bed_number)
);
COMMENT ON TABLE public.student_allocations IS 'å­¸ç”ŸåºŠä½åˆ†é…è¡¨ï¼Œç”¨æ–¼å­¸è™ŸæŸ¥è©¢ã€‚';


-- --- ç¬¬ 2 éƒ¨åˆ†ï¼šå»ºç«‹å¤–éµ (Foreign Key) é—œè¯ (å®‰å…¨æ¨¡å¼) ---
--
-- ----------------------------------------------------------------

-- 1. `profiles` -> `auth.users`
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_id_fkey;
ALTER TABLE public.profiles
ADD CONSTRAINT profiles_id_fkey
FOREIGN KEY (id)
REFERENCES auth.users (id)
ON DELETE CASCADE;

-- 2. `user_roles` -> `auth.users`
ALTER TABLE public.user_roles DROP CONSTRAINT IF EXISTS user_roles_user_id_fkey;
ALTER TABLE public.user_roles
ADD CONSTRAINT user_roles_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES auth.users (id)
ON DELETE CASCADE;

-- 3. `rooms` -> `dorm_zones`
ALTER TABLE public.rooms DROP CONSTRAINT IF EXISTS rooms_zone_id_fkey;
ALTER TABLE public.rooms
ADD CONSTRAINT rooms_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE CASCADE;

-- 4. `checklist_items` -> `checklist_categories`
ALTER TABLE public.checklist_items DROP CONSTRAINT IF EXISTS checklist_items_category_id_fkey;
ALTER TABLE public.checklist_items
ADD CONSTRAINT checklist_items_category_id_fkey
FOREIGN KEY (category_id)
REFERENCES public.checklist_categories (id)
ON DELETE CASCADE;

-- 5. `reports` -> `profiles`
ALTER TABLE public.reports DROP CONSTRAINT IF EXISTS reports_user_id_fkey;
ALTER TABLE public.reports
ADD CONSTRAINT reports_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES public.profiles (id)
ON DELETE SET NULL;

-- 6. `reports` -> `dorm_zones`
ALTER TABLE public.reports DROP CONSTRAINT IF EXISTS reports_zone_id_fkey;
ALTER TABLE public.reports
ADD CONSTRAINT reports_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE SET NULL;

-- 7. `reports` -> `rooms`
ALTER TABLE public.reports DROP CONSTRAINT IF EXISTS reports_room_id_fkey;
ALTER TABLE public.reports
ADD CONSTRAINT reports_room_id_fkey
FOREIGN KEY (room_id)
REFERENCES public.rooms (id)
ON DELETE SET NULL;

-- 8. `reports` -> `check_types`
ALTER TABLE public.reports DROP CONSTRAINT IF EXISTS reports_check_type_id_fkey;
ALTER TABLE public.reports
ADD CONSTRAINT reports_check_type_id_fkey
FOREIGN KEY (check_type_id)
REFERENCES public.check_types (id)
ON DELETE SET NULL;

-- 9. `key_returns` -> `profiles`
ALTER TABLE public.key_returns DROP CONSTRAINT IF EXISTS key_returns_user_id_fkey;
ALTER TABLE public.key_returns
ADD CONSTRAINT key_returns_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES public.profiles (id)
ON DELETE SET NULL;

-- 10. `key_returns` -> `dorm_zones`
ALTER TABLE public.key_returns DROP CONSTRAINT IF EXISTS key_returns_zone_id_fkey;
ALTER TABLE public.key_returns
ADD CONSTRAINT key_returns_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE RESTRICT;

-- 11. `key_returns` -> `rooms`
ALTER TABLE public.key_returns DROP CONSTRAINT IF EXISTS key_returns_room_id_fkey;
ALTER TABLE public.key_returns
ADD CONSTRAINT key_returns_room_id_fkey
FOREIGN KEY (room_id)
REFERENCES public.rooms (id)
ON DELETE RESTRICT;

-- 12. `student_allocations` -> `rooms`
ALTER TABLE public.student_allocations DROP CONSTRAINT IF EXISTS student_allocations_room_id_fkey;
ALTER TABLE public.student_allocations
ADD CONSTRAINT student_allocations_room_id_fkey
FOREIGN KEY (room_id)
REFERENCES public.rooms (id)
ON DELETE CASCADE;

-- 13. `student_allocations` -> `dorm_zones`
ALTER TABLE public.student_allocations DROP CONSTRAINT IF EXISTS student_allocations_zone_id_fkey;
ALTER TABLE public.student_allocations
ADD CONSTRAINT student_allocations_zone_id_fkey
FOREIGN KEY (zone_id)
REFERENCES public.dorm_zones (id)
ON DELETE CASCADE;


-- --- ç¬¬ 3 éƒ¨åˆ†ï¼šè³‡æ–™åº«å‡½æ•¸ (RPC) èˆ‡è§¸ç™¼å™¨ (Triggers) ---
--
-- ----------------------------------------------------------------

-- 1. å‡½æ•¸ï¼šç²å–ç›®å‰ä½¿ç”¨è€…çš„è§’è‰²
CREATE OR REPLACE FUNCTION public.get_my_role()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
    SELECT role
    FROM public.user_roles
    WHERE user_id = auth.uid();
$$;

-- 2. å‡½æ•¸ï¼šè™•ç†æ–°ä½¿ç”¨è€…è¨»å†Š (ç‚º profiles å’Œ user_roles è¨­å®šç´€éŒ„)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    -- 1. åœ¨ profiles å»ºç«‹ç´€éŒ„
    INSERT INTO public.profiles (id, email)
    VALUES (NEW.id, NEW.email)
    ON CONFLICT (id) DO NOTHING;

    -- 2. åœ¨ user_roles å»ºç«‹ç´€éŒ„ï¼Œé è¨­ç‚º 'inspector'
    INSERT INTO public.user_roles (user_id, role)
    VALUES (NEW.id, 'inspector')
    ON CONFLICT (user_id) DO NOTHING;

    RETURN NEW;
END;
$$;

-- 3. è§¸ç™¼å™¨ï¼šç•¶ auth.users æœ‰æ–°ä½¿ç”¨è€…æ™‚ï¼ŒåŸ·è¡Œ handle_new_user
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_user();


-- 4. å‡½æ•¸ï¼šæ›´æ–°ä½¿ç”¨è€…è§’è‰² (for ManageUsers.vue)
CREATE OR REPLACE FUNCTION public.update_user_role(target_user_id uuid, new_role text)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    -- æª¢æŸ¥åŸ·è¡Œè€…æ˜¯å¦ç‚º 'admin'
    IF public.get_my_role() != 'admin' THEN
        RAISE EXCEPTION 'æ¬Šé™ä¸è¶³ï¼šåªæœ‰ admin å¯ä»¥æ›´æ”¹ä½¿ç”¨è€…è§’è‰²';
    END IF;

    -- æª¢æŸ¥æ˜¯å¦è©¦åœ–æ›´æ”¹è‡ªå·±çš„è§’è‰² (é›–ç„¶å‰ç«¯å·²æ“‹ï¼Œå¾Œç«¯å†æ“‹ä¸€æ¬¡æ›´å®‰å…¨)
    IF target_user_id = auth.uid() THEN
        RAISE EXCEPTION 'ç„¡æ³•æ›´æ”¹è‡ªå·±çš„è§’è‰²';
    END IF;

    -- æ›´æ–°æˆ–æ’å…¥è§’è‰²
    INSERT INTO public.user_roles (user_id, role)
    VALUES (target_user_id, new_role)
    ON CONFLICT (user_id)
    DO UPDATE SET role = new_role;
END;
$$;


-- --- ç¬¬ 4 éƒ¨åˆ†ï¼šå„²å­˜é«” (Storage) ---
--
-- ----------------------------------------------------------------

INSERT INTO storage.buckets (id, name, public)
VALUES ('photos', 'photos', true)
ON CONFLICT (id) DO NOTHING;

DROP POLICY IF EXISTS "Allow authenticated users to upload photos" ON storage.objects;
CREATE POLICY "Allow authenticated users to upload photos"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK ( bucket_id = 'photos' );

DROP POLICY IF EXISTS "Allow public read access to photos" ON storage.objects;
CREATE POLICY "Allow public read access to photos"
ON storage.objects FOR SELECT
USING ( bucket_id = 'photos' );


-- --- ç¬¬ 5 éƒ¨åˆ†ï¼šè³‡æ–™åˆ—å±¤ç´šå®‰å…¨æ€§ (RLS) ç­–ç•¥ ---
--
-- ----------------------------------------------------------------

-- 5a. dorm_zones
ALTER TABLE public.dorm_zones ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read zones" ON public.dorm_zones;
DROP POLICY IF EXISTS "Allow admin to manage zones" ON public.dorm_zones;
CREATE POLICY "Allow authenticated users to read zones" ON public.dorm_zones FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage zones" ON public.dorm_zones FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- 5b. rooms
ALTER TABLE public.rooms ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read rooms" ON public.rooms;
DROP POLICY IF EXISTS "Allow admin to manage rooms" ON public.rooms;
CREATE POLICY "Allow authenticated users to read rooms" ON public.rooms FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage rooms" ON public.rooms FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- 5c. check_types
ALTER TABLE public.check_types ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read check_types" ON public.check_types;
DROP POLICY IF EXISTS "Allow admin to manage check_types" ON public.check_types;
CREATE POLICY "Allow authenticated users to read check_types" ON public.check_types FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage check_types" ON public.check_types FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- 5d. checklist_categories
ALTER TABLE public.checklist_categories ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read categories" ON public.checklist_categories;
DROP POLICY IF EXISTS "Allow admin to manage categories" ON public.checklist_categories;
CREATE POLICY "Allow authenticated users to read categories" ON public.checklist_categories FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage categories" ON public.checklist_categories FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- 5e. checklist_items
ALTER TABLE public.checklist_items ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to read items" ON public.checklist_items;
DROP POLICY IF EXISTS "Allow admin to manage items" ON public.checklist_items;
CREATE POLICY "Allow authenticated users to read items" ON public.checklist_items FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admin to manage items" ON public.checklist_items FOR ALL TO authenticated USING (public.get_my_role() = 'admin') WITH CHECK (public.get_my_role() = 'admin');

-- 5f. profiles
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow admins to read all profiles" ON public.profiles;
DROP POLICY IF EXISTS "Allow users to read their own profile" ON public.profiles;
CREATE POLICY "Allow admins to read all profiles" ON public.profiles FOR SELECT TO authenticated USING (public.get_my_role() = 'admin');
CREATE POLICY "Allow users to read their own profile" ON public.profiles FOR SELECT TO authenticated USING (id = auth.uid());

-- 5g. user_roles
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow admins to read all user_roles" ON public.user_roles;
CREATE POLICY "Allow admins to read all user_roles" ON public.user_roles FOR SELECT TO authenticated USING (public.get_my_role() = 'admin');

-- 5h. reports
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to insert reports" ON public.reports;
DROP POLICY IF EXISTS "Allow admins to read all reports" ON public.reports;
DROP POLICY IF EXISTS "Allow admins to delete all reports" ON public.reports;
DROP POLICY IF EXISTS "Allow inspectors to read their own reports" ON public.reports;
DROP POLICY IF EXISTS "Allow inspectors to delete their own reports" ON public.reports;

CREATE POLICY "Allow authenticated users to insert reports" ON public.reports FOR INSERT TO authenticated WITH CHECK ( user_id = auth.uid() );
CREATE POLICY "Allow admins to read all reports" ON public.reports FOR SELECT TO authenticated USING ( public.get_my_role() = 'admin' );
CREATE POLICY "Allow admins to delete all reports" ON public.reports FOR DELETE TO authenticated USING ( public.get_my_role() = 'admin' );
CREATE POLICY "Allow inspectors to read their own reports" ON public.reports FOR SELECT TO authenticated USING ( user_id = auth.uid() );
CREATE POLICY "Allow inspectors to delete their own reports" ON public.reports FOR DELETE TO authenticated USING ( user_id = auth.uid() );

-- 5i. key_returns
ALTER TABLE public.key_returns ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow authenticated users to insert key_returns" ON public.key_returns;
DROP POLICY IF EXISTS "Allow admins to read all key_returns" ON public.key_returns;
DROP POLICY IF EXISTS "Allow inspectors to read their own key_returns" ON public.key_returns;

CREATE POLICY "Allow authenticated users to insert key_returns" ON public.key_returns FOR INSERT TO authenticated WITH CHECK ( user_id = auth.uid() );
CREATE POLICY "Allow admins to read all key_returns" ON public.key_returns FOR SELECT TO authenticated USING ( public.get_my_role() = 'admin' );
CREATE POLICY "Allow inspectors to read their own key_returns" ON public.key_returns FOR SELECT TO authenticated USING ( user_id = auth.uid() );

-- 5j. student_allocations (NEW RLS)
ALTER TABLE public.student_allocations ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow all authenticated users to read student allocations" ON public.student_allocations;
CREATE POLICY "Allow all authenticated users to read student allocations" ON public.student_allocations FOR SELECT TO authenticated USING ( true );
DROP POLICY IF EXISTS "Allow admins to manage student allocations" ON public.student_allocations;
CREATE POLICY "Allow admins to manage student allocations" ON public.student_allocations FOR ALL TO authenticated USING ( public.get_my_role() = 'admin' ) WITH CHECK ( public.get_my_role() = 'admin' );


-- --- ç¬¬ 6 éƒ¨åˆ†ï¼šç¯„ä¾‹è³‡æ–™ (Sample Data) ---
--
-- ----------------------------------------------------------------

INSERT INTO public.check_types (name, description)
VALUES
    ('å­¸æœŸåˆæª¢æŸ¥', 'æª¢æŸ¥å­¸ç”Ÿå…¥ä½å‰çš„æˆ¿é–“ç‹€æ³'),
    ('æœŸä¸­å®‰å…¨æª¢æŸ¥', 'ä¾‹è¡Œæ€§çš„å®‰å…¨èˆ‡è¡›ç”ŸæŠ½æŸ¥'),
    ('å¯’å‡é›¢å®¿æª¢æŸ¥', 'ç¢ºèªå­¸ç”Ÿå¯’å‡é›¢å®¿æ™‚çš„æ¸…ç©ºç‹€æ³')
ON CONFLICT (name) DO NOTHING;

INSERT INTO public.dorm_zones (name, description)
VALUES
    ('A å€ (ç”·ç”Ÿå®¿èˆ)', 'A å€ä½æ–¼æ±å´ï¼Œé è¿‘ç±ƒçƒå ´'),
    ('B å€ (å¥³ç”Ÿå®¿èˆ)', 'B å€ä½æ–¼è¥¿å´ï¼Œé è¿‘é¤å»³')
ON CONFLICT (name) DO NOTHING;

INSERT INTO public.rooms (zone_id, room_number)
SELECT id, room_list.room_number
FROM public.dorm_zones, (VALUES ('101'), ('102'), ('201'), ('202')) AS room_list(room_number)
ON CONFLICT (zone_id, room_number) DO NOTHING;

-- ç¯„ä¾‹åºŠä½åˆ†é… (ç”¨æ–¼æ¸¬è©¦ KeyReturn.vue çš„æŸ¥æ‰¾åŠŸèƒ½)
INSERT INTO public.student_allocations (student_id, zone_id, room_id, bed_number)
SELECT 
    'A111001', 
    dz.id, 
    r.id, 
    '1'
FROM 
    public.dorm_zones dz, 
    public.rooms r
WHERE 
    dz.name = 'A å€ (ç”·ç”Ÿå®¿èˆ)' AND r.room_number = '101' AND r.zone_id = dz.id
ON CONFLICT (student_id) DO NOTHING;


INSERT INTO public.checklist_categories (name, icon, display_order)
VALUES
    ('å¯¢å®¤å€åŸŸ', 'ğŸ›ï¸', 1),
    ('è¡›æµ´å€åŸŸ', 'ğŸ›', 2),
    ('å…¬å…±å€åŸŸ/é™½å°', 'ğŸª´', 3)
ON CONFLICT (name) DO NOTHING;

INSERT INTO public.checklist_items (category_id, name, display_order)
VALUES
    ((SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'), 'åºŠæ¶ (å«åºŠæ¿)', 1),
    ((SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'), 'æ›¸æ¡Œ', 2),
    ((SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'), 'æ¤…å­', 3),
    ((SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'), 'è¡£æ«ƒ', 4),
    ((SELECT id FROM public.checklist_categories WHERE name = 'å¯¢å®¤å€åŸŸ'), 'å†·æ°£ (å«é™æ§å™¨)', 5),

    ((SELECT id FROM public.checklist_categories WHERE name = 'è¡›æµ´å€åŸŸ'), 'é¦¬æ¡¶ (å«æ°´ç®±)', 1),
    ((SELECT id FROM public.checklist_categories WHERE name = 'è¡›æµ´å€åŸŸ'), 'æ´—æ‰‹å° (å«æ°´é¾é ­)', 2),
    ((SELECT id FROM public.checklist_categories WHERE name = 'è¡›æµ´å€åŸŸ'), 'æ·‹æµ´è¨­å‚™ (å«è“®è“¬é ­)', 3),
    ((SELECT id FROM public.checklist_categories WHERE name = 'è¡›æµ´å€åŸŸ'), 'ç½®ç‰©æ¶', 4),

    ((SELECT id FROM public.checklist_categories WHERE name = 'å…¬å…±å€åŸŸ/é™½å°'), 'åœ°æ¿æ¸…æ½”', 1),
    ((SELECT id FROM public.checklist_categories WHERE name = 'å…¬å…±å€åŸŸ/é™½å°'), 'é™½å°çª—æˆ¶', 2)
ON CONFLICT (category_id, name) DO NOTHING;


-- ----------------------------------------------------------------
-- --- è…³æœ¬åŸ·è¡Œå®Œç•¢ ---
-- ----------------------------------------------------------------